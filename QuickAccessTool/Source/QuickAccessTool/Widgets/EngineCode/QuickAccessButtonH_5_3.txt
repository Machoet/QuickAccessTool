// QuickAccessButtonH_5_3.txt
// UE5.3-aligned. Fix for C2487: export macro only on class; use SLATE_DECLARE_WIDGET (no *_API).

#pragma once

#include "CoreMinimal.h"
#include "Misc/Attribute.h"
#include "Input/Reply.h"
#include "Widgets/DeclarativeSyntaxSupport.h"
#include "Styling/SlateColor.h"
#include "Layout/Margin.h"
#include "Sound/SlateSound.h"
#include "Styling/SlateTypes.h"
#include "Styling/CoreStyle.h"
#include "Framework/SlateDelegates.h"
#include "Styling/SlateWidgetStyleAsset.h"
#include "Widgets/Layout/SBorder.h"

#ifndef QUICKACCESSTOOL_API
#define QUICKACCESSTOOL_API
#endif

class FPaintArgs;
class FSlateWindowElementList;
enum class ETextFlowDirection : uint8;
enum class ETextShapingMethod : uint8;

class QUICKACCESSTOOL_API SQuickAccessButton : public SBorder
{
	SLATE_DECLARE_WIDGET(SQuickAccessButton, SBorder)

#if WITH_ACCESSIBILITY
	friend class FSlateAccessibleButton;
#endif

public:
	SLATE_BEGIN_ARGS(SQuickAccessButton)
		: _Content()
		, _ButtonStyle(&FCoreStyle::Get().GetWidgetStyle<FButtonStyle>("Button"))
		, _TextStyle(&FCoreStyle::Get().GetWidgetStyle<FTextBlockStyle>("ButtonText"))
		, _HAlign(HAlign_Fill)
		, _VAlign(VAlign_Fill)
		, _ContentPadding(FMargin(4.0, 2.0))
		, _Text()
		, _ClickMethod(EButtonClickMethod::DownAndUp)
		, _TouchMethod(EButtonTouchMethod::DownAndUp)
		, _PressMethod(EButtonPressMethod::DownAndUp)
		, _DesiredSizeScale(FVector2D(1,1))
		, _ContentScale(FVector2D(1,1))
		, _ButtonColorAndOpacity(FLinearColor::White)
		, _ForegroundColor(FSlateColor::UseStyle())
		, _IsFocusable(true)
	{}

		SLATE_DEFAULT_SLOT(FArguments, Content)

		SLATE_STYLE_ARGUMENT(FButtonStyle, ButtonStyle)
		SLATE_STYLE_ARGUMENT(FTextBlockStyle, TextStyle)

		SLATE_ARGUMENT(EHorizontalAlignment, HAlign)
		SLATE_ARGUMENT(EVerticalAlignment, VAlign)

		SLATE_ATTRIBUTE(FMargin, ContentPadding)
		SLATE_ATTRIBUTE(FText, Text)

		SLATE_EVENT(FOnClicked, OnClicked)
		SLATE_EVENT(FOnClicked, OnDoubleClicked)
		SLATE_EVENT(FSimpleDelegate, OnPressed)
		SLATE_EVENT(FSimpleDelegate, OnReleased)
		SLATE_EVENT(FSimpleDelegate, OnHovered)
		SLATE_EVENT(FSimpleDelegate, OnUnhovered)

		SLATE_ARGUMENT(EButtonClickMethod::Type, ClickMethod)
		SLATE_ARGUMENT(EButtonTouchMethod::Type, TouchMethod)
		SLATE_ARGUMENT(EButtonPressMethod::Type, PressMethod)

		SLATE_ATTRIBUTE(FVector2D, DesiredSizeScale)
		SLATE_ATTRIBUTE(FVector2D, ContentScale)

		SLATE_ATTRIBUTE(FSlateColor, ButtonColorAndOpacity)
		SLATE_ATTRIBUTE(FSlateColor, ForegroundColor)

		SLATE_ARGUMENT(bool, IsFocusable)

		SLATE_ARGUMENT(TOptional<FSlateSound>, PressedSoundOverride)
		SLATE_ARGUMENT(TOptional<FSlateSound>, HoveredSoundOverride)

		SLATE_ARGUMENT(TOptional<ETextShapingMethod>, TextShapingMethod)
		SLATE_ARGUMENT(TOptional<ETextFlowDirection>, TextFlowDirection)
	SLATE_END_ARGS()

protected:
	SQuickAccessButton();

public:
	UE_DEPRECATED(5.0, "GetBorder is deprecated. Use SetBorderImage or GetBorderImage")
	virtual const FSlateBrush* GetBorder() const
	{
		return GetBorderImage();
	}

	bool IsPressed() const
	{
		return bIsPressed || AppearPressedAttribute.Get();
	}

	void Construct(const FArguments& InArgs);

	void SetContentPadding(TAttribute<FMargin> InContentPadding);
	void SetHoveredSound(TOptional<FSlateSound> InHoveredSound);
	void SetPressedSound(TOptional<FSlateSound> InPressedSound);
	void SetOnClicked(FOnClicked InOnClicked);
	void SetOnDoubleClicked(FOnClicked InOnDoubleClicked);
	void SetOnHovered(FSimpleDelegate InOnHovered);
	void SetOnUnhovered(FSimpleDelegate InOnUnhovered);
	void SetButtonStyle(const FButtonStyle* InButtonStyle);
	void SetClickMethod(EButtonClickMethod::Type InClickMethod);
	void SetTouchMethod(EButtonTouchMethod::Type InTouchMethod);
	void SetPressMethod(EButtonPressMethod::Type InPressMethod);

public:
	virtual int32 OnPaint(const FPaintArgs& Args, const FGeometry& AllottedGeometry, const FSlateRect& MyCullingRect,
		FSlateWindowElementList& OutDrawElements, int32 LayerId, const FWidgetStyle& InWidgetStyle, bool bParentEnabled) const override;
	virtual bool SupportsKeyboardFocus() const override;
	virtual void OnFocusLost(const FFocusEvent& InFocusEvent) override;
	virtual FReply OnKeyDown(const FGeometry& MyGeometry, const FKeyEvent& InKeyEvent) override;
	virtual FReply OnKeyUp(const FGeometry& MyGeometry, const FKeyEvent& InKeyEvent) override;
	virtual FReply OnMouseButtonDown(const FGeometry& MyGeometry, const FPointerEvent& MouseEvent) override;
	virtual FReply OnMouseButtonDoubleClick(const FGeometry& MyGeometry, const FPointerEvent& InMouseEvent) override;
	virtual FReply OnMouseButtonUp(const FGeometry& MyGeometry, const FPointerEvent& MouseEvent) override;
	virtual FReply OnMouseMove(const FGeometry& MyGeometry, const FPointerEvent& MouseEvent) override;
	virtual void OnMouseEnter(const FGeometry& MyGeometry, const FPointerEvent& MouseEvent) override;
	virtual void OnMouseLeave(const FPointerEvent& MouseEvent) override;
	virtual void OnMouseCaptureLost(const FCaptureLostEvent& CaptureLostEvent) override;
	virtual bool IsInteractable() const override;
#if WITH_ACCESSIBILITY
	virtual TSharedRef<FSlateAccessibleWidget> CreateAccessibleWidget() override;
#endif

protected:
	virtual FVector2D ComputeDesiredSize(float) const override;

protected:
	virtual void Press();
	virtual void Release();
	FReply ExecuteOnClick();
	FMargin GetCombinedPadding() const;
	bool GetShowDisabledEffect() const;
	TEnumAsByte<EButtonClickMethod::Type> GetClickMethodFromInputType(const FPointerEvent& MouseEvent) const;
	bool IsPreciseTapOrClick(const FPointerEvent& MouseEvent) const;
	void PlayPressedSound() const;
	void PlayHoverSound() const;
	void ExecuteHoverStateChanged(bool bPlaySound);

private:
	void UpdatePressStateChanged();
	void UpdatePadding();
	void UpdateShowDisabledEffect();
	void UpdateBorderImage();
	void UpdateForegroundColor();
	void UpdateDisabledForegroundColor();

private:
	FVector2D PressedScreenSpacePosition;

	const FButtonStyle* Style = nullptr;

	FOnClicked OnClicked;
	FOnClicked OnDoubleClicked;
	FSimpleDelegate OnPressed;
	FSimpleDelegate OnReleased;
	FSimpleDelegate OnHovered;
	FSimpleDelegate OnUnhovered;

	FSlateSound HoveredSound;
	FSlateSound PressedSound;

	TEnumAsByte<EButtonClickMethod::Type> ClickMethod;
	TEnumAsByte<EButtonTouchMethod::Type>   TouchMethod;
	TEnumAsByte<EButtonPressMethod::Type>   PressMethod;

	uint8 bIsFocusable : 1;
	uint8 bIsPressed   : 1;

private:
	TSlateAttribute<FSlateColor> BorderForegroundColorAttribute;
	TSlateAttribute<FMargin>     ContentPaddingAttribute;
	TSlateAttribute<bool>        AppearPressedAttribute;
};